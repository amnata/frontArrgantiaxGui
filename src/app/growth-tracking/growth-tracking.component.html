<div class="container">
  <button class="btn-cancel" (click)="goHome()">
    <img src="assets/icons/back.svg" alt="Retour" class="icon" />
  </button>
  
  <h1>ğŸ“ˆ Suivi de Croissance</h1>
  <p class="subtitle">Monitoring et analyse de l'Ã©volution de vos cultures</p>

  <!-- Add Measurement -->
  <div class="add-measurement">
    <h3>â• Ajouter une Mesure</h3>
    <div class="form-grid">
      <div class="form-group">
        <label>Plante</label>
        <select [(ngModel)]="newMeasurement.plantId" class="form-control">
          <option value="0">SÃ©lectionner une plante...</option>
          <option *ngFor="let plant of plants" [value]="plant.id">
            {{ plant.name }} ({{ plant.cropType }})
          </option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Hauteur (cm)</label>
        <input type="number" [(ngModel)]="newMeasurement.height" class="form-control" placeholder="Ex: 45" min="0" step="0.1">
      </div>
      
      <div class="form-group">
        <label>Stade de croissance</label>
        <select [(ngModel)]="newMeasurement.stage" class="form-control">
          <option *ngFor="let stage of growthStages" [value]="stage.value">
            {{ stage.label }}
          </option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Ã‰tat sanitaire</label>
        <select [(ngModel)]="newMeasurement.healthStatus" class="form-control">
          <option *ngFor="let health of healthStatuses" [value]="health.value">
            {{ health.label }}
          </option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Date</label>
        <input type="date" [(ngModel)]="newMeasurement.date" class="form-control">
      </div>
      
      <div class="form-group">
        <label>Notes (optionnel)</label>
        <textarea [(ngModel)]="newMeasurement.notes" class="form-control" rows="2" placeholder="Observations..."></textarea>
      </div>

      <!-- Capteurs pour l'IA (optionnel) -->
      <div class="form-group full-width">
        <h4>ğŸ“Š DonnÃ©es Capteurs (Optionnel - pour l'IA)</h4>
        <div class="sensors-grid">
          <div class="sensor-input">
            <label>Chlorophylle (SPAD)</label>
            <input type="number" [(ngModel)]="newMeasurement.chlorophyllContent" placeholder="35.0" step="0.1">
          </div>
          <div class="sensor-input">
            <label>TempÃ©rature Air (Â°C)</label>
            <input type="number" [(ngModel)]="newMeasurement.ambientTemperature" placeholder="25.0" step="0.1">
          </div>
          <div class="sensor-input">
            <label>TempÃ©rature Sol (Â°C)</label>
            <input type="number" [(ngModel)]="newMeasurement.soilTemperature" placeholder="23.0" step="0.1">
          </div>
          <div class="sensor-input">
            <label>HumiditÃ© (%)</label>
            <input type="number" [(ngModel)]="newMeasurement.humidity" placeholder="60.0" step="0.1">
          </div>
          <div class="sensor-input">
            <label>LumiÃ¨re (lux)</label>
            <input type="number" [(ngModel)]="newMeasurement.lightIntensity" placeholder="1200" step="10">
          </div>
          <div class="sensor-input">
            <label>Signal Ã‰lectro (mV)</label>
            <input type="number" [(ngModel)]="newMeasurement.electrochemicalSignal" placeholder="0.5" step="0.01">
          </div>
        </div>
      </div>
    </div>
    
    <button (click)="addMeasurement()" class="add-btn" [disabled]="!isFormValid() || isLoading">
      <span *ngIf="!isLoading">â• Enregistrer avec Analyse IA</span>
      <span *ngIf="isLoading">â³ Traitement en cours...</span>
    </button>

    <div class="connection-status" *ngIf="plants.length === 0">
      <p>ğŸ”Œ Connexion au serveur... Utilisation du mode local</p>
    </div>
  </div>

  <!-- Statistics Dashboard -->
  <div class="statistics-dashboard" *ngIf="measurements.length > 0">
    <h3>ğŸ“Š Statistiques Globales</h3>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">ğŸ“</div>
        <div class="stat-value">{{getAverageHeight()}} cm</div>
        <div class="stat-label">Hauteur Moyenne</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">ğŸŒ±</div>
        <div class="stat-value">{{measurements.length}}</div>
        <div class="stat-label">Mesures EnregistrÃ©es</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">ğŸŒ¾</div>
        <div class="stat-value">{{getActiveCrops()}}</div>
        <div class="stat-label">Cultures Suivies</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">âœ…</div>
        <div class="stat-value">{{getHealthyPercentage()}}%</div>
        <div class="stat-label">SantÃ© Globale</div>
      </div>
    </div>
  </div>

  <!-- Growth Chart -->
  <div class="growth-chart" *ngIf="measurements.length > 0">
    <h3>ğŸ“ˆ Ã‰volution de la Croissance</h3>
    <div class="chart-container">
      <div class="chart-legend">
        <div class="legend-item" *ngFor="let crop of getUniqueCrops()">
          <span class="legend-color" [style.background-color]="getCropColor(crop)"></span>
          <span>{{getCropDisplayName(crop)}}</span>
        </div>
      </div>
      <div class="chart-area">
        <svg viewBox="0 0 800 400" class="chart-svg">
          <!-- Grid lines -->
          <line x1="50" y1="20" x2="50" y2="350" stroke="#e2e8f0" stroke-width="2"/>
          <line x1="50" y1="350" x2="750" y2="350" stroke="#e2e8f0" stroke-width="2"/>
          
          <!-- Y-axis labels -->
          <text x="30" y="30" font-size="12" fill="#718096">100cm</text>
          <text x="30" y="105" font-size="12" fill="#718096">75cm</text>
          <text x="30" y="180" font-size="12" fill="#718096">50cm</text>
          <text x="30" y="255" font-size="12" fill="#718096">25cm</text>
          <text x="30" y="355" font-size="12" fill="#718096">0cm</text>
          
          <!-- Data lines -->
          <ng-container *ngFor="let crop of getUniqueCrops()">
            <polyline 
              [attr.points]="getChartPoints(crop)" 
              fill="none" 
              [attr.stroke]="getCropColor(crop)" 
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"/>
            <g *ngFor="let point of getChartPointsArray(crop)">
              <circle 
                [attr.cx]="point.x" 
                [attr.cy]="point.y" 
                r="6" 
                [attr.fill]="getCropColor(crop)"/>
              <title>Hauteur: {{point.height}} cm - Date: {{point.date}}</title>
            </g>
          </ng-container>
        </svg>
      </div>
    </div>
  </div>

  <!-- Measurements Table -->
  <div class="measurements-table" *ngIf="measurements.length > 0">
    <h3>ğŸ“‹ Historique des Mesures</h3>
    
    <div class="filter-section">
      <!-- Filtre par culture -->
      <div class="filter-group">
        <label>Filtrer par culture:</label>
        <select [(ngModel)]="filterCrop" class="form-control filter-select">
          <option value="">Toutes les cultures</option>
          <option *ngFor="let crop of getAvailableCrops()" [value]="crop">
            {{getCropDisplayName(crop)}}
          </option>
        </select>
      </div>
      
      <!-- PrÃ©dictions par culture -->
      <div class="filter-group">
        <label>PrÃ©dictions pour la culture:</label>
        <select [(ngModel)]="selectedCropForPrediction" class="form-control">
          <option value="">Choisir une culture...</option>
          <option *ngFor="let crop of getAvailableCrops()" [value]="crop">
            {{getCropDisplayName(crop)}}
          </option>
        </select>
        
        <button class="predict-btn" (click)="getPredictionsByCrop()" 
                [disabled]="!selectedCropForPrediction">
          ğŸ¯ Obtenir des PrÃ©dictions
        </button>
      </div>
    </div>

    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Plante</th>
            <th>Culture</th>
            <th>Hauteur</th>
            <th>Stade</th>
            <th>Ã‰tat Sanitaire</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let m of getFilteredMeasurements(); let i = index">
            <td>{{formatDate(m.date || '')}}</td>
            <td>{{getPlantName(m.plantId)}}</td>
            <td>{{getCropType(m.plantId)}}</td>
            <td><strong>{{m.height}} cm</strong></td>
            <td>{{m.stage}}</td>
            <td>
              <span class="health-badge" [ngClass]="'health-' + getHealthClass(m.healthStatus)">
                {{m.healthStatus}}
              </span>
            </td>
            <td>{{m.notes || '-'}}</td>
            <td>
              <button (click)="deleteMeasurement(i)" class="delete-btn" title="Supprimer">
                ğŸ—‘ï¸
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- PrÃ©dictions IA -->
  <div class="predictions-panel" *ngIf="showPredictions && predictions">
    <h3>ğŸ¯ PrÃ©dictions IA</h3>
    <div class="predictions-grid">
      <div class="prediction-card">
        <div class="prediction-icon">ğŸ“</div>
        <!-- <div class="prediction-value">{{ (predictions.predictions?.predicted_height ?? 0)?.toFixed(1) }} cm</div>PrÃ©dictions IA -->
        <div class="prediction-value">{{ displayPrediction.predicted_height.toFixed(1) }} cm</div>
        <div class="prediction-label">Hauteur PrÃ©dite</div>
      </div>
      
      <div class="prediction-card">
        <div class="prediction-icon">â¤ï¸</div>
        <div class="prediction-value">{{ ((predictions.predictions?.health_score ?? 0) * 100)?.toFixed(0) }}</div>
        <div class="prediction-label">Score SantÃ©</div>
      </div>
      
      <div class="prediction-card">
        <div class="prediction-icon">ğŸ“ˆ</div>
        <div class="prediction-value">{{ (predictions.predictions?.growth_rate ?? 0)?.toFixed(1) }} cm/j</div>
        <div class="prediction-label">Taux Croissance</div>
      </div>

      <div class="prediction-card">
        <div class="prediction-icon">ğŸƒ</div>
        <div class="prediction-value">{{ (predictions.predictions?.predicted_chlorophyll ?? 0)?.toFixed(1) }} SPAD</div>
        <div class="prediction-label">Chlorophylle PrÃ©dite</div>
      </div>
    </div>

    <!-- Recommandations IA -->
    <div class="recommendations" *ngIf="predictions.recommendations && predictions.recommendations.length > 0">
      <h4>ğŸ’¡ Recommandations Intelligentes</h4>
      <ul>
        <li *ngFor="let rec of predictions.recommendations">{{ rec }}</li>
      </ul>
    </div>

    <div class="model-info" *ngIf="predictions.predictions?.model_used">
      <small>ModÃ¨le utilisÃ©: {{ predictions.predictions.model_used }}</small>
    </div>

    <button class="close-predictions" (click)="showPredictions = false">
      âœ• Fermer
    </button>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="measurements.length === 0">
    <div class="empty-icon">ğŸ“Š</div>
    <h3>Aucune mesure enregistrÃ©e</h3>
    <p>Commencez Ã  suivre la croissance de vos cultures en ajoutant votre premiÃ¨re mesure ci-dessus.</p>
  </div>
</div>